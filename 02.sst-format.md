## [BlockBasedSST](https://github.com/facebook/rocksdb/wiki/Rocksdb-BlockBasedTable-Format)
```
<beginning_of_file>
  [data block 1]
  [data block 2]
  ...
  [data block N]
  [meta block 1: filter block]                  (see section: "filter" Meta Block)
  [meta block 2: index block]                   (实际上是放在footer中!)
  [meta block 3: compression dictionary block]  (see section: "compression dictionary" Meta Block)
  [meta block 4: range deletion block]          (see section: "range deletion" Meta Block)
  [meta block 5: stats block]                   (see section: "properties" Meta Block)

  [meta block K: future extended block]  (we may add more meta blocks in the future)
  [metaindex block]
  [Footer]                               (fixed size; starts at file_size - sizeof(Footer))
<end_of_file>
```
footer的大小固定为48Bytes，格式为：
// legacy footer format:
```
  metaindex handle (varint64 offset, varint64 size)
  index handle     (varint64 offset, varint64 size)
  <padding> to make the total size 2 * BlockHandle::kMaxEncodedLength
  table_magic_number (8 bytes)
```
// new footer format:
```
  checksum type       (char, 1 byte)
  metaindex handle    (varint64 offset, varint64 size)
  index handle        (varint64 offset, varint64 size)
      <padding> to make the total size 2 * BlockHandle::kMaxEncodedLength + 1
  footer version      (4 bytes)
  table_magic_number  (8 bytes)
```
<img src="images/sst-footer.png" width="960px" />
[备注：Leveldb SST格式](https://github.com/google/leveldb/blob/main/doc/table_format.md)

#### 核心代码
```
  // Write meta blocks, metaindex block and footer in the following order.
  //    1. [meta block: filter]
  //    2. [meta block: index]
  //    3. [meta block: compression dictionary]
  //    4. [meta block: range deletion tombstone]
  //    5. [meta block: properties]
  //    6. [metaindex block]
  //    7. Footer
  BlockHandle metaindex_block_handle, index_block_handle;
  MetaIndexBuilder meta_index_builder;
  WriteFilterBlock(&meta_index_builder);
  WriteIndexBlock(&meta_index_builder, &index_block_handle);
  WriteCompressionDictBlock(&meta_index_builder);
  WriteRangeDelBlock(&meta_index_builder);
  WritePropertiesBlock(&meta_index_builder);

  if (ok()) {
    // flush the meta index block
    WriteRawBlock(meta_index_builder.Finish(), kNoCompression,
      &metaindex_block_handle, BlockType::kMetaIndex);
  }
  if (ok()) {
    WriteFooter(metaindex_block_handle, index_block_handle);
  }
```
